<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± â€“ KemetX</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo","Segoe UI",system-ui,Arial,sans-serif;transition:background .3s,color .3s}

    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --primary:#38bdf8;
      --chip:#1f2937;
      --border:#1f2937;
    }
    :root.light {
      --bg:#f9fafb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --accent:#16a34a;
      --warn:#d97706;
      --danger:#dc2626;
      --primary:#0284c7;
      --chip:#e5e7eb;
      --border:#d1d5db;
    }

    header{position:sticky;top:0;backdrop-filter:blur(8px);background:var(--card);border-bottom:1px solid var(--border);z-index:20}
    header .nav{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    header nav a{margin:0 8px;text-decoration:none;color:var(--text);font-weight:600}
    header nav a:hover{color:var(--primary)}

    .menu-btn{display:none;cursor:pointer;font-size:22px;background:none;border:0;color:var(--text)}
    .side-menu{position:fixed;top:0;right:-260px;width:240px;height:100%;background:var(--card);box-shadow:-2px 0 10px rgba(0,0,0,.4);transition:.3s;padding:20px;z-index:25}
    .side-menu.active{right:0}
    .side-menu a{display:block;margin:14px 0;text-decoration:none;color:var(--text);font-weight:600}
    .side-menu a:hover{color:var(--primary)}

    .theme-toggle{cursor:pointer;border:0;background:var(--chip);color:var(--text);padding:6px 10px;border-radius:8px}

    @media(max-width:768px){
      header nav{display:none}
      .menu-btn{display:block}
    }

    .container{max-width:1100px;margin:auto;padding:18px}
    h1{margin:0 0 6px 0;font-weight:800;font-size:clamp(20px,3vw,28px)}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:1.2fr .8fr}
    @media(max-width:920px){.grid-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);transition:background .3s,color .3s}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"]{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);outline:none}
    input[type="text"]:focus,input[type="number"]:focus{border-color:var(--primary)}
    input::placeholder{color:#6b7280}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:700;transition:all .2s}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover:not(:disabled){background:#0369a1}
    .btn-ghost{background:var(--bg);border:1px solid var(--border);color:var(--text)}
    .btn-ghost:hover:not(:disabled){background:var(--chip)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover:not(:disabled){background:#dc2626}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right}
    tbody td{background:var(--bg);border:1px solid var(--border);padding:12px;vertical-align:middle;transition:background .3s,color .3s}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    tbody tr:hover td{background:var(--chip)}

    .badge{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;display:inline-block}
    .buy{background:rgba(34,197,94,.15);color:#16a34a;border:1px solid rgba(34,197,94,.35)}
    .hold{background:rgba(245,158,11,.15);color:#d97706;border:1px solid rgba(245,158,11,.35)}
    .avoid{background:rgba(239,68,68,.15);color:#dc2626;border:1px solid rgba(239,68,68,.35)}

    .risk-low{color:#16a34a}
    .risk-med{color:#d97706}
    .risk-high{color:#dc2626}

    .sep{height:1px;background:var(--border);margin:12px 0}
    .footer{color:var(--muted);font-size:12px;margin-top:20px;text-align:center;padding:20px;border-top:1px solid var(--border)}

    .kbd{border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:var(--bg);color:var(--muted);font-size:12px}

    .empty-state{text-align:center;color:var(--muted);padding:40px 20px}

    .loading{opacity:0.7;pointer-events:none}
    
    @media(max-width:600px){
      .actions{flex-direction:column}
      .row{grid-template-columns:1fr;gap:8px}
      table{font-size:14px}
      tbody td{padding:8px}
    }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header>
    <div class="container nav">
      <h1 style="font-size:20px;margin:0">Ø«Ø§Ù†Ø¯Ø±</h1>
      <nav>
        <a href="#">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="#">Ù…Ù† Ù†Ø­Ù†</a>
        <a href="#">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
        <a href="#">Ù…Ù„ÙÙŠ</a>
      </nav>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="theme-toggle" id="themeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
        <button class="menu-btn" id="menuBtn" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      </div>
    </div>
  </header>

  <!-- ===== Side Menu ===== -->
  <aside class="side-menu" id="sideMenu" aria-hidden="true">
    <a href="#">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#">Ù…Ù† Ù†Ø­Ù†</a>
    <a href="#">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
    <a href="#">Ù…Ù„ÙÙŠ</a>
  </aside>

  <main class="container grid grid-2" style="margin-top:14px">
    <!-- Form Card -->
    <section class="card">
      <h2 style="margin:0 0 10px 0">Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ„</h2>
      <div class="chips" style="margin-bottom:12px">
        <span class="chip">Ù…Ø«Ø§Ù„: ÙÙˆØ±ÙŠØŒ Ø¥ÙŠ Ø¥Ù Ø¬ÙŠØŒ MSFT</span>
        <span class="chip">Ø§Ù„Ø¹Ù…Ù„Ø© ØºÙŠØ± Ù…Ù‡Ù…Ø© â€“ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</span>
      </div>
      <form id="assetForm">
        <div class="row">
          <div>
            <label for="name">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© / Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
            <input id="name" type="text" placeholder="Ù…Ø«Ø§Ù„: MSFT Ø£Ùˆ ÙÙˆØ±ÙŠ" required />
          </div>
          <div>
            <label for="p_now">Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…</label>
            <input id="p_now" type="number" min="0" step="0.0001" placeholder="0.00" required />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="p_6m">Ø³Ø¹Ø± Ù…Ù†Ø° Ù¦ Ø£Ø´Ù‡Ø±</label>
            <input id="p_6m" type="number" min="0" step="0.0001" placeholder="0.00" required />
          </div>
          <div>
            <label for="p_1y">Ø³Ø¹Ø± Ù…Ù†Ø° Ø³Ù†Ø©</label>
            <input id="p_1y" type="number" min="0" step="0.0001" placeholder="0.00" required />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="p_5y">Ø³Ø¹Ø± Ù…Ù†Ø° Ù¥ Ø³Ù†ÙˆØ§Øª</label>
            <input id="p_5y" type="number" min="0" step="0.0001" placeholder="0.00" required />
          </div>
          <div>
            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="notes" type="text" placeholder="Ù‚Ø·Ø§Ø¹ØŒ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…â€¦" />
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button type="submit" class="btn btn-primary" id="addBtn">Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>
          <button type="button" class="btn btn-ghost" id="resetForm">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </form>
      <div class="footer">ØªÙ„Ù…ÙŠØ­: Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„ Ø£Ùˆ ØªØ­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
    </section>

    <!-- Insights Card -->
    <section class="card">
      <h2 style="margin:0 0 10px 0">Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø±</h2>
      <div class="chips">
        <span class="chip">CAGR Ù¥ Ø³Ù†ÙŠÙ†</span>
        <span class="chip">Ø¹Ø§Ø¦Ø¯ Ø³Ù†Ø©</span>
        <span class="chip">Ø¹Ø§Ø¦Ø¯ Ù¦ Ø£Ø´Ù‡Ø±</span>
        <span class="chip">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© = ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯</span>
      </div>
      <div class="sep"></div>
      <ul style="margin:0;padding-right:18px;line-height:1.9">
        <li>CAGR = <code>(Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ… / Ø³Ø¹Ø± Ù¥ Ø³Ù†ÙŠÙ†)^(1/5) âˆ’ 1</code></li>
        <li>Ø¹Ø§Ø¦Ø¯ Ø³Ù†Ø© + Ø¹Ø§Ø¦Ø¯ Ù¦ Ø£Ø´Ù‡Ø±</li>
        <li>Ø³ÙƒÙˆØ± Ø§Ù„Ø²Ø®Ù… = 20% Ù…Ù† CAGR + 30% Ù…Ù† Ø³Ù†Ø© + 50% Ù…Ù† Ù¦ Ø£Ø´Ù‡Ø±</li>
        <li>Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© = Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹ÙˆØ§Ø¦Ø¯</li>
        <li>Ø§Ù„Ù‚Ø±Ø§Ø±:
          <ul style="margin-top:6px;line-height:1.7">
            <li><span class="badge buy">Ø´Ø±Ø§Ø¡</span> Ø¥Ø°Ø§ Ø§Ù„Ø²Ø®Ù… â‰¥ 10% ÙˆÙƒÙ„ Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</li>
            <li><span class="badge hold">Ø§Ø­ØªÙØ§Ø¸</span> Ø¥Ø°Ø§ Ø¨ÙŠÙ† 0â€“10%</li>
            <li><span class="badge avoid">ØªØ¬Ù†Ø¨</span> Ø¥Ø°Ø§ Ø§Ù„Ø²Ø®Ù… Ø³Ø§Ù„Ø¨</li>
          </ul>
        </li>
      </ul>
      <div class="sep"></div>
      <div style="color:var(--muted)">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ Ø£Ø¯Ø§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆÙ„ÙŠØ³Øª Ù†ØµÙŠØ­Ø© Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©. Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ø¨Ø­Ø§Ø«Ùƒ ÙˆØªÙ†ÙˆÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©.</div>
    </section>

    <!-- Table Card -->
    <section class="card" style="grid-column:1/-1">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <h2 style="margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙˆÙ„</h2>
        <div class="actions">
          <button class="btn btn-ghost" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
          <button class="btn btn-ghost" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
          <button class="btn btn-danger" id="wipeBtn">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù¦ Ø£Ø´Ù‡Ø±</th><th>Ø³Ù†Ø©</th><th>Ù¥ Ø³Ù†ÙŠÙ† (CAGR)</th>
              <th>Ø§Ù„Ø²Ø®Ù…</th><th>Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©</th><th>Ø§Ù„Ù‚Ø±Ø§Ø±</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="emptyState" class="empty-state" style="display:none">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</p>
        <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø£ØµÙ„ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
      </div>
      <div class="footer">Ø§Ø®ØªØµØ§Ø±: Ø¯ÙˆØ¨Ù„ ÙƒÙ„ÙŠÙƒ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹.</div>
    </section>
  </main>

  <template id="row-template">
    <tr>
      <td class="nm"></td><td class="r6"></td><td class="r1"></td>
      <td class="r5"></td><td class="mom"></td><td class="risk"></td>
      <td class="rec"></td><td class="nt"></td><td class="ops"></td>
    </tr>
  </template>

  <footer class="footer">Â© 2025 Ø«Ø§Ù†Ø¯Ø± â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>

  <script>
    // ================= Utilities =================
    const $ = (q, el=document) => el.querySelector(q);
    const fmtPct = (x) => (isFinite(x) && x !== null ? (x*100).toFixed(1) : "-") + "%";

    function safeUUID(){
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'id-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*1e6).toString(36);
    }

    // ================= Metrics =================
    function calcMetrics(p5y, p1y, p6m, pnow){
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const values = [p5y, p1y, p6m, pnow];
      if(values.some(v => !isFinite(v) || v <= 0)) {
        return { r6m: 0, r1y: 0, cagr5: 0, momentum: 0, risk: 0, riskLevel: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', decision: 'hold' };
      }

      const r6m = (pnow / p6m) - 1;
      const r1y = (pnow / p1y) - 1;
      const cagr5 = Math.pow(pnow / p5y, 1/5) - 1;
      const momentum = 0.2*cagr5 + 0.3*r1y + 0.5*r6m;
      
      const arr = [r6m, r1y, cagr5];
      const mean = arr.reduce((a,b)=>a+b,0)/3;
      const variance = arr.reduce((s,v)=>s+Math.pow(v-mean,2),0)/3;
      const risk = Math.sqrt(variance);
      
      let decision = 'hold';
      if(momentum >= 0.10 && r6m>0 && r1y>0 && cagr5>0) decision = 'buy';
      else if(momentum < 0) decision = 'avoid';
      
      let riskLevel = 'Ù…Ù†Ø®ÙØ¶';
      if(risk >= 0.25) riskLevel = 'Ø¹Ø§Ù„ÙŠ';
      else if(risk >= 0.12) riskLevel = 'Ù…ØªÙˆØ³Ø·';
      
      return { r6m, r1y, cagr5, momentum, risk, riskLevel, decision };
    }

    function badgeDecision(dec){
      if(dec==='buy') return `<span class="badge buy">Ø´Ø±Ø§Ø¡</span>`;
      if(dec==='avoid') return `<span class="badge avoid">ØªØ¬Ù†Ø¨</span>`;
      return `<span class="badge hold">Ø§Ø­ØªÙØ§Ø¸</span>`;
    }

    function riskColor(level){
      if(level==='Ø¹Ø§Ù„ÙŠ') return 'risk-high';
      if(level==='Ù…ØªÙˆØ³Ø·') return 'risk-med';
      return 'risk-low';
    }

    // ================= State (in-memory storage) =================
    const KEY = 'invest-dashboard-v1';
    let state = [];
    let editingId = null;
    let currentTheme = 'dark';

    // Ù…Ø­Ø§ÙƒÙŠ localStorage Ù„Ù„Ø¨ÙŠØ¦Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù…Ù‡
    const storage = {
      data: {},
      getItem(key) {
        return this.data[key] || null;
      },
      setItem(key, value) {
        this.data[key] = value;
      },
      removeItem(key) {
        delete this.data[key];
      }
    };

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ
    const store = (typeof localStorage !== 'undefined' && localStorage !== null) ? localStorage : storage;

    function loadState(){
      try {
        const saved = store.getItem(KEY);
        state = saved ? JSON.parse(saved) : [];
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        state = state.filter(item => 
          item && item.id && item.name && 
          isFinite(item.pnow) && item.pnow > 0 &&
          isFinite(item.p6m) && item.p6m > 0 &&
          isFinite(item.p1y) && item.p1y > 0 &&
          isFinite(item.p5y) && item.p5y > 0
        );
      } catch(e) {
        console.warn('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
        state = [];
      }
    }

    function save(){ 
      try {
        store.setItem(KEY, JSON.stringify(state)); 
      } catch(e) {
        console.warn('Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
      }
    }

    function upsert(item){
      const idx = state.findIndex(x => x.id === item.id);
      if(idx > -1) state[idx] = item; 
      else state.push(item);
      save(); 
      render();
    }

    function remove(id){
      state = state.filter(x => x.id !== id);
      save(); 
      render();
    }

    // ================= Render =================
    function render(){
      const tbody = $('#rows');
      const emptyState = $('#emptyState');
      
      if(state.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      tbody.innerHTML = '';
      
      state.forEach(row => {
        const t = document.importNode($('#row-template').content, true);
        const cells = {
          nm: $('.nm', t), r6: $('.r6', t), r1: $('.r1', t), r5: $('.r5', t),
          mom: $('.mom', t), risk: $('.risk', t), rec: $('.rec', t), nt: $('.nt', t), ops: $('.ops', t)
        };
        
        const m = calcMetrics(row.p5y, row.p1y, row.p6m, row.pnow);
        
        cells.nm.textContent = row.name;
        cells.r6.textContent = fmtPct(m.r6m);
        cells.r1.textContent = fmtPct(m.r1y);
        cells.r5.textContent = fmtPct(m.cagr5);
        cells.mom.innerHTML = `<strong>${fmtPct(m.momentum)}</strong>`;
        cells.risk.innerHTML = `<span class="${riskColor(m.riskLevel)}">${m.riskLevel}</span>`;
        cells.rec.innerHTML = badgeDecision(m.decision);
        cells.nt.textContent = row.notes || '';

        // actions
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-ghost'; 
        editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = (e) => { e.stopPropagation(); startEdit(row.id); };

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-danger'; 
        delBtn.textContent = 'Ø­Ø°Ù';
        delBtn.onclick = (e) => { 
          e.stopPropagation(); 
          if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£ØµÙ„ØŸ')) remove(row.id); 
        };

        cells.ops.style.whiteSpace = 'nowrap';
        cells.ops.append(editBtn, ' ', delBtn);

        // double-click to quick-edit
        const tr = t.querySelector('tr');
        tr.ondblclick = () => startEdit(row.id);
        tr.style.cursor = 'pointer';
        tr.title = 'Ø¯ÙˆØ¨Ù„ ÙƒÙ„ÙŠÙƒ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„';

        tbody.appendChild(t);
      });
    }

    // ================= Form =================
    function resetForm(){
      editingId = null;
      const form = $('#assetForm');
      form.reset();
      $('#addBtn').textContent = 'Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«';
    }

    function startEdit(id){
      const row = state.find(x => x.id === id);
      if(!row) return;
      
      editingId = id;
      $('#name').value = row.name;
      $('#p_now').value = row.pnow;
      $('#p_6m').value = row.p6m;
      $('#p_1y').value = row.p1y;
      $('#p_5y').value = row.p5y;
      $('#notes').value = row.notes || '';
      $('#addBtn').textContent = 'ØªØ­Ø¯ÙŠØ«';
      
      // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function onSubmit(e){
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      
      const name = $('#name').value.trim();
      const pnow = parseFloat($('#p_now').value);
      const p6m = parseFloat($('#p_6m').value);
      const p1y = parseFloat($('#p_1y').value);
      const p5y = parseFloat($('#p_5y').value);
      const notes = $('#notes').value.trim();

      if(!name){ 
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚'); 
        $('#name').focus();
        return; 
      }
      
      const fields = [pnow, p6m, p1y, p5y];
      if(fields.some(x => !isFinite(x) || x <= 0)){
        alert('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¹Ø§Ø± ØµØ­ÙŠØ­Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª');
        return;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù†Ø·Ù‚ÙŠØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
      if(p5y > pnow * 100) {
        if(!confirm('Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ù¥ Ø³Ù†ÙˆØ§Øª ÙŠØ¨Ø¯Ùˆ Ø¹Ø§Ù„ÙŠØ§Ù‹ Ø¬Ø¯Ø§Ù‹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      }

      const item = {
        id: editingId || safeUUID(),
        name,
        pnow: Number(pnow.toFixed(4)),
        p6m: Number(p6m.toFixed(4)),
        p1y: Number(p1y.toFixed(4)),
        p5y: Number(p5y.toFixed(4)),
        notes,
        ts: Date.now()
      };
      
      upsert(item);
      resetForm();
    }

    // ================= Import / Export / Wipe =================
    function exportJSON(){
      if(state.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        return;
      }
      
      try {
        const dataWithMetadata = {
          version: '1.0',
          exported_at: new Date().toISOString(),
          data: state
        };
        
        const blob = new Blob([JSON.stringify(dataWithMetadata, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `invest-dashboard-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      } catch(e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
    }

    function importJSON(){
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'application/json';
      inp.onchange = () => {
        const file = inp.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const imported = JSON.parse(reader.result);
            let data;
            
            // Ø¯Ø¹Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            if(imported.data && Array.isArray(imported.data)) {
              data = imported.data; // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            } else if(Array.isArray(imported)) {
              data = imported; // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            } else {
              throw new Error('ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const validData = data.filter(x => 
              x && x.id && x.name && 
              isFinite(x.pnow) && x.pnow > 0 &&
              isFinite(x.p6m) && x.p6m > 0 &&
              isFinite(x.p1y) && x.p1y > 0 &&
              isFinite(x.p5y) && x.p5y > 0
            );
            
            if(validData.length === 0) {
              alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©');
              return;
            }
            
            const shouldReplace = confirm(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${validData.length} Ø¹Ù†ØµØ± ØµØ§Ù„Ø­. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ`);
            
            if(shouldReplace) {
              state = validData;
            } else {
              // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              validData.forEach(item => {
                item.id = safeUUID(); // Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
                state.push(item);
              });
            }
            
            save();
            render();
            alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­: ${validData.length} Ø¹Ù†ØµØ±`);
          } catch(e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', e);
            alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù JSON ØµØ§Ù„Ø­');
          }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    function wipeAll(){
      if(confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')){
        state = [];
        save();
        render();
        resetForm();
        alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    // ================= Theme & Side Menu =================
    let themeToggle, menuBtn, sideMenu;

    function applyTheme(theme){
      currentTheme = theme;
      if(theme === 'light') {
        document.documentElement.classList.add('light');
      } else {
        document.documentElement.classList.remove('light');
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      const toggle = $('#themeToggle');
      if(toggle) {
        toggle.textContent = (theme === 'light') ? 'â˜€ï¸' : 'ğŸŒ™';
      }
      
      try {
        store.setItem('theme', theme);
      } catch(e) {
        console.warn('Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±
    function initTheme(){
      try {
        const saved = store.getItem('theme');
        if(saved) {
          applyTheme(saved);
        } else {
          // Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù† ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
          const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
          applyTheme(prefersLight ? 'light' : 'dark');
        }
      } catch(e) {
        console.warn('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
        applyTheme('dark'); // Ø§ÙØªØ±Ø§Ø¶ÙŠ
      }
    }

    // ================= Event Listeners =================
    function initEventListeners(){
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ DOM
      themeToggle = $('#themeToggle');
      menuBtn = $('#menuBtn');
      sideMenu = $('#sideMenu');

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
      if(!themeToggle || !menuBtn || !sideMenu) {
        console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø²Ø± Ø§Ù„Ù…Ø¸Ù‡Ø±');
        return;
      }

      // Theme toggle
      themeToggle.onclick = () => {
        const newTheme = (currentTheme === 'light') ? 'dark' : 'light';
        applyTheme(newTheme);
      };

      // Side menu toggle
      menuBtn.onclick = () => {
        const isActive = sideMenu.classList.toggle('active');
        sideMenu.setAttribute('aria-hidden', !isActive);
      };

      // Close side menu on link click
      sideMenu.querySelectorAll('a').forEach(a => {
        a.onclick = () => {
          sideMenu.classList.remove('active');
          sideMenu.setAttribute('aria-hidden', 'true');
        };
      });

      // Close side menu when clicking outside
      document.addEventListener('click', (e) => {
        if(sideMenu && !sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
          sideMenu.classList.remove('active');
          sideMenu.setAttribute('aria-hidden', 'true');
        }
      });

      // Form submission
      const form = $('#assetForm');
      if(form) {
        form.addEventListener('submit', onSubmit);
      }
      
      const resetBtn = $('#resetForm');
      if(resetBtn) {
        resetBtn.onclick = resetForm;
      }

      // Import/Export/Wipe
      const exportBtn = $('#exportBtn');
      const importBtn = $('#importBtn');
      const wipeBtn = $('#wipeBtn');
      
      if(exportBtn) exportBtn.onclick = exportJSON;
      if(importBtn) importBtn.onclick = importJSON;
      if(wipeBtn) wipeBtn.onclick = wipeAll;

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // ESC Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if(e.key === 'Escape' && editingId) {
          resetForm();
        }
        
        // Ctrl+S Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…ØªØµÙØ­)
        if(e.ctrlKey && e.key === 's') {
          e.preventDefault();
          const nameInput = $('#name');
          if(nameInput && nameInput.value.trim()) {
            const form = $('#assetForm');
            if(form) form.dispatchEvent(new Event('submit'));
          }
        }
      });

      // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù†Ù…Ø§Ø°Ø¬
      const inputs = ['name','p_now','p_6m','p_1y','p_5y','notes'];
      inputs.forEach(id => {
        const el = $('#'+id);
        if(!el) return;
        
        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù€ Enter
        el.addEventListener('keydown', (e) => {
          if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const currentIndex = inputs.indexOf(id);
            const nextIndex = currentIndex + 1;
            
            if(nextIndex < inputs.length) {
              const nextEl = $('#'+inputs[nextIndex]);
              if(nextEl) nextEl.focus();
            } else {
              // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± Ø­Ù‚Ù„ØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
              const form = $('#assetForm');
              if(form) form.dispatchEvent(new Event('submit'));
            }
          }
        });

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        if(el.type === 'number') {
          el.addEventListener('blur', () => {
            const value = parseFloat(el.value);
            if(isFinite(value) && value > 0) {
              el.value = value.toFixed(4).replace(/\.?0+$/, '');
            }
          });
        }
      });
    }

    // ================= Initialization =================
    function init(){
      loadState();
      initTheme();
      initEventListeners();

      // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if(state.length === 0){
        const demo = [
          { name: 'MSFT', p5y: 135, p1y: 410, p6m: 440, pnow: 450, notes: 'ØªÙ‚Ù†ÙŠØ© ÙƒØ¨Ø±Ù‰ - Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØª' },
          { name: 'SPY',  p5y: 290, p1y: 500, p6m: 520, pnow: 530, notes: 'ØµÙ†Ø¯ÙˆÙ‚ S&P 500' },
          { name: 'ÙÙˆØ±ÙŠ',  p5y: 15,  p1y: 6,   p6m: 7.5, pnow: 7.2, notes: 'Fintech Ù…ØµØ±' }
        ];
        demo.forEach(d => {
          const item = { 
            id: safeUUID(), 
            ...d, 
            ts: Date.now() 
          };
          state.push(item);
        });
        save();
      }
      
      render();

      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
      setTimeout(() => {
        const hasSeenWelcome = store.getItem('hasSeenWelcome');
        if(!hasSeenWelcome && state.length <= 3) {
          const showWelcome = confirm('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±!\n\nØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ Ø£Ù… Ø­Ø°ÙÙ‡Ø§ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ\n\nÙ…ÙˆØ§ÙÙ‚ = Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ù…Ø«Ù„Ø©\nØ¥Ù„ØºØ§Ø¡ = Ø­Ø°Ù Ø§Ù„Ø£Ù…Ø«Ù„Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯');
          
          if(!showWelcome) {
            state = [];
            save();
            render();
          }
          
          store.setItem('hasSeenWelcome', 'true');
        }
      }, 1000);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // ØªØµØ¯ÙŠØ± Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ
    window.investmentDashboard = {
      state,
      calcMetrics,
      exportData: () => JSON.stringify(state, null, 2),
      importData: (data) => {
        try {
          state = JSON.parse(data);
          save();
          render();
          return true;
        } catch(e) {
          console.error(e);
          return false;
        }
      },
      version: '1.1.0'
    };
  </script>
</body>
</html>